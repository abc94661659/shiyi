<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linshiyi.interaction.mapper.CommentMapper">


    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO comment (entity_type, entity_id, user_id, content, parent_id)
        VALUES (#{entityType}, #{entityId}, #{userId}, #{content}, #{parentId})
    </insert>

    <select id="selectById" resultType="com.linshiyi.interaction.domain.po.Comment">
        SELECT id, entity_type, entity_id, user_id, parent_id, content, is_deleted
        FROM comment
        WHERE id = #{id}
    </select>

    <select id="selectParentComment" resultType="com.linshiyi.interaction.domain.po.Comment">
        SELECT id,
               entity_type,
               entity_id,
               user_id,
               parent_id,
               content,
               is_deleted,
               create_time
        FROM comment
        WHERE entity_type = #{dto.entityType}
          AND entity_id = #{dto.entityId}
          AND parent_id IS NULL
          AND is_deleted = 0
        ORDER BY create_time DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countParentComment" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM comment
        WHERE entity_type = #{dto.entityType}
          AND entity_id = #{dto.entityId}
          AND parent_id IS NULL
          AND is_deleted = 0
    </select>
    <select id="countChildComment" resultType="java.lang.Long">
        SELECT COUNT(*) - 1
        FROM "comment" c
                 INNER JOIN comment_closure cc ON c.id = cc.descendant_id
        WHERE cc.ancestor_id = #{parentId}
          AND is_deleted = 0
    </select>
    <select id="selectChildCommentWithPaging" resultType="com.linshiyi.interaction.domain.vo.CommentVO">
        SELECT c.*, p.user_id AS reply_to_user_id
        FROM "comment" c
                 INNER JOIN "comment_closure" cc ON c.id = cc.descendant_id
                 INNER JOIN "comment" p ON c.parent_id = p.id
        WHERE cc.ancestor_id = #{parentId}
          AND c.id != #{parentId}
          AND c.is_deleted = 0
        ORDER BY c.create_time ASC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
    <select id="selectTopNChildCommentsByParentIds" resultType="com.linshiyi.interaction.domain.po.Comment">
        SELECT id, entity_type, entity_id, user_id, parent_id, content, is_deleted, create_time
        FROM (
        SELECT
        id, entity_type, entity_id, user_id, parent_id, content, is_deleted, create_time,
        ROW_NUMBER() OVER (PARTITION BY parent_id ORDER BY create_time ASC) as rn
        FROM comment
        WHERE parent_id IN
        <foreach collection="parentIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
        ) ranked
        WHERE rn &lt;= #{limitPerParent}
        ORDER BY parent_id, create_time ASC
    </select>

</mapper>
